<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªØ³Ø¬ÙŠÙ„ - Ø§Ù„ØªÙ„Ø§Ø¹Ø¨Ø§Øª</title>
    <link rel="stylesheet" href="MD.css">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="main-container">
        <div class="side-panel">
            <h2>âš¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <div id="editIndicator" class="edit-indicator">ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø´Ø·</div>

            <div class="input-group"><label>Ø§Ù„Ù‚Ø·Ø§Ø¹</label><input id="keta3"></div>
            <div class="input-group"><label>Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©</label><input id="handsa"></div>
            <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ</label><input id="mname"></div>
            <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</label><input id="mno"></div>

            <div class="row-flex">
                <div class="input-group"><label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© kWh</label><input id="kwh_reading" type="number"></div>
                <div class="input-group"><label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© kVARh</label><input id="kvarh_reading" type="number"></div>
            </div>

            <div class="row-flex">
                <div class="input-group"><label>Ø£Ù‚ØµÙ‰ Ø­Ù…Ù„</label><input id="max_load" type="number"></div>
                <div class="input-group"><label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù‚Ø¯Ø±Ø©</label><input id="power_factor" type="number" step="0.01">
                </div>
            </div>

            <div class="row-flex">
                <div class="input-group"><label>Ù…Ø­ÙˆÙ„ Ø¬Ù‡Ø¯</label><input id="vt_ratio" value="11000/110"></div>
                <div class="input-group"><label>Ù…Ø­ÙˆÙ„ ØªÙŠØ§Ø±</label><input id="ct_ratio" value="200/5"></div>
            </div>

            <div class="row-flex">
                <div class="input-group"><label>Ø§Ù„Ø«Ø§Ø¨Øª</label><input id="constant" type="number"></div>
                <div class="input-group"><label>Ø§Ù„Ù…ÙƒØ§Ù†</label><input id="location"></div>
            </div>

            <div class="row-flex">
                <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹</label><input type="date" id="inspection_date"></div>
                <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨</label><input type="date" id="fix_date"></div>
            </div>

            <div class="row-flex">
                <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚</label><input type="date" id="power_date"></div>
                <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="date" id="passing_date"></div>
            </div>

            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯</label>
                <select id="mtype">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                    <option>EDMI</option>
                    <option>Global</option>
                    <option>Smart</option>
                    <option>Micro Stare</option>
                </select>
            </div>

            <div class="input-group"><label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="munip"></textarea></div>

            <div class="action-btns">
                <button class="btn-save btn-full" onclick="quickSave()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn-clear" onclick="clearForm()">ğŸ§¹ ØªÙØ±ÙŠØº</button>
                <button class="btn-excel" onclick="document.getElementById('excelFile').click()">ğŸ“¥ Ø±ÙØ¹ Excel</button>
            </div>
            <input type="file" id="excelFile" accept=".xls,.xlsx" hidden />
        </div>

        <div class="table-panel">
            <div
                style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px;">
                <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalRecords">0</span>)</h3>

                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ù‚Ø·Ø§Ø¹..."
                    style="flex: 1; max-width: 400px; padding: 8px; border-radius: 20px; border: 1px solid #ddd;">

                <button
                    style="background:#f39c12; color:white; padding: 8px 15px; border-radius: 5px; cursor: pointer; border:none;"
                    onclick="loadDataFromFirebase()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Ù…</th>
                            <th>Ø§Ù„Ù‚Ø·Ø§Ø¹</th>
                            <th>Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©</th>
                            <th>Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                            <th>kWh</th>
                            <th>kVARh</th>
                            <th>Ø£Ù‚ØµÙ‰ Ø­Ù…Ù„</th>
                            <th>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù‚Ø¯Ø±Ø©</th>
                            <th>Ù…Ø­ÙˆÙ„Ø§Øª Ø¬Ù‡Ø¯</th>
                            <th>Ù…Ø­ÙˆÙ„Ø§Øª ØªÙŠØ§Ø±</th>
                            <th>Ø§Ù„Ø«Ø§Ø¨Øª</th>
                            <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø·Ù„Ø§Ù‚</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±ÙˆØ±</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th>Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
        import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
            databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„
        const fieldMap = {
            keta3: 'keta3',
            handsa: 'handsa',
            mname: 'metername',
            mno: 'meternumber',
            kwh_reading: 'kwh_reading',
            kvarh_reading: 'kvarh_reading',
            max_load: 'max_load',
            power_factor: 'power_factor',
            vt_ratio: 'vt_ratio',
            ct_ratio: 'ct_ratio',
            constant: 'constant',
            location: 'location',
            inspection_date: 'inspection_date',
            fix_date: 'fix_date',
            power_date: 'power_date',
            passing_date: 'passing_date',
            mtype: 'metertype',
            munip: 'metermunip'
        };

        let currentEditKey = null;
        let allData = [];

        window.quickSave = async function () {
            const record = {};
            let hasData = false;
            for (let id in fieldMap) {
                const val = document.getElementById(id).value;
                record[fieldMap[id]] = val;
                if (val) hasData = true;
            }
            if (!hasData) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹", "warning");

            try {
                if (currentEditKey) {
                    await set(ref(db, `MD/meterdata/${currentEditKey}`), record);
                } else {
                    await push(ref(db, "MD/meterdata"), record);
                }
                clearForm();
                loadDataFromFirebase();
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', timer: 1000, showConfirmButton: false });
            } catch (e) { Swal.fire("Ø®Ø·Ø£", e.message, "error"); }
        };

        window.loadDataFromFirebase = async function () {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "<tr><td colspan='20'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</td></tr>";

            try {
                const snapshot = await get(ref(db, "MD/meterdata"));
                allData = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        allData.push({ key: child.key, ...child.val() });
                    });
                    renderTable(allData);
                } else {
                    tableBody.innerHTML = "<tr><td colspan='20'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>";
                    document.getElementById("totalRecords").innerText = "0";
                }
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan='20'>Ø®Ø·Ø£: ${e.message}</td></tr>`;
            }
        };

        function renderTable(dataArray) {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            let count = 0;

            dataArray.forEach((data) => {
                count++;
                const row = document.createElement("tr");
                if (currentEditKey === data.key) row.className = "selected-row";

                row.onclick = () => fillForm(data.key, data);
                row.innerHTML = `
                    <td>${count}</td>
                    <td>${data.keta3 || ''}</td>
                    <td>${data.handsa || ''}</td>
                    <td>${data.metername || ''}</td>
                    <td>${data.meternumber || ''}</td>
                    <td>${data.kwh_reading || '0'}</td>
                    <td>${data.kvarh_reading || '0'}</td>
                    <td>${data.max_load || '0'}</td>
                    <td>${data.power_factor || '0'}</td>
                    <td>${data.vt_ratio || ''}</td>
                    <td>${data.ct_ratio || ''}</td>
                    <td>${data.constant || ''}</td>
                    <td>${data.location || ''}</td>
                    <td>${data.inspection_date || ''}</td>
                    <td>${data.fix_date || ''}</td>
                    <td>${data.power_date || ''}</td>
                    <td>${data.passing_date || ''}</td>
                    <td>${data.metertype || ''}</td>
                    <td title="${data.metermunip || ''}">${data.metermunip ? data.metermunip.substring(0, 15) + '...' : ''}</td>
                    <td><button onclick="event.stopPropagation(); deleteRec('${data.key}')" style="background:#e74c3c; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Ø­Ø°Ù</button></td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById("totalRecords").innerText = count;
        }

        document.getElementById("searchInput").addEventListener("input", function (e) {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(item =>
                (item.metername && item.metername.toLowerCase().includes(term)) ||
                (item.meternumber && item.meternumber.toString().includes(term)) ||
                (item.keta3 && item.keta3.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        window.fillForm = function (key, data) {
            currentEditKey = key;
            document.getElementById("editIndicator").style.display = "block";
            for (let id in fieldMap) {
                const dbField = fieldMap[id];
                document.getElementById(id).value = data[dbField] || "";
            }
        };

        window.clearForm = function () {
            currentEditKey = null;
            document.getElementById("editIndicator").style.display = "none";
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.id === 'vt_ratio') el.value = "11000/110";
                else if (el.id === 'ct_ratio') el.value = "200/5";
                else el.value = "";
            });
        };

        window.deleteRec = async function (key) {
            const conf = await Swal.fire({ title: 'Ø­Ø°ÙØŸ', icon: 'warning', showCancelButton: true });
            if (conf.isConfirmed) {
                await remove(ref(db, `MD/meterdata/${key}`));
                loadDataFromFirebase();
            }
        };

        // Ø¯Ø§Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡
        function getVal(row, possibleKeys) {
            const keys = Object.keys(row);
            for (let pKey of possibleKeys) {
                const found = keys.find(k => {
                    const cleanK = k.toString().replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                    const cleanP = pKey.toString().trim();
                    return cleanK === cleanP || cleanK.includes(cleanP);
                });
                if (found) return row[found];
            }
            return '';
        }

        document.getElementById("excelFile").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©...', didOpen: () => Swal.showLoading() });

                    for (let row of json) {
                        const record = {
                            keta3: getVal(row, ['Ø§Ù„Ù‚Ø·Ø§Ø¹']),
                            handsa: getVal(row, ['Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©', 'Ø§Ù„Ù‡Ù†Ø¯Ø³Ù‡']), // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡Ø§Ø¡ ÙˆØ§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
                            metername: getVal(row, ['Ø§Ù„Ø§Ø³Ù…']),
                            meternumber: getVal(row, ['Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯']), // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø³Ù…Ù‰ Ù…Ù„ÙÙƒ
                            kwh_reading: getVal(row, ['Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ùƒ.Ùˆ.Ø³', 'kwh']),
                            kvarh_reading: getVal(row, ['Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ùƒ.ÙØ§Ø± .Ø³', 'kvarh']),
                            max_load: getVal(row, ['Ø§Ù‚ØµÙ‰ Ø­Ù…Ù„']),
                            power_factor: getVal(row, ['Ù…Ø¹Ø§Ù…Ù„ Ù‚Ø¯Ø±Ø©', 'Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù‚Ø¯Ø±Ø©']),
                            vt_ratio: getVal(row, ['Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„Ø¬Ù‡Ø¯', 'Ø¬Ù‡Ø¯']) || '11000/110',
                            ct_ratio: getVal(row, ['Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„ØªÙŠØ§Ø±', 'ØªÙŠØ§Ø±']) || '200/5',
                            constant: getVal(row, ['Ø§Ù„Ø«Ø§Ø¨Øª']),
                            location: getVal(row, ['Ù…ÙƒØ§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ¨', 'Ø§Ù„Ù…ÙƒØ§Ù†']),
                            inspection_date: getVal(row, ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹']),
                            fix_date: getVal(row, ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨']),
                            power_date: getVal(row, ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø·Ù„Ø§Ù‚']),
                            passing_date: getVal(row, ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±ÙˆØ±']),
                            metertype: getVal(row, ['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯']),
                            metermunip: getVal(row, ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'])
                        };
                        await push(ref(db, "MD/meterdata"), record);
                    }
                    Swal.fire("Ù†Ø¬Ø§Ø­", `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${json.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`, "success");
                    loadDataFromFirebase();
                } catch (err) {
                    Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        loadDataFromFirebase();
    </script>
</body>

</html>